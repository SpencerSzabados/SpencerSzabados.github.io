<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Fine-Tune Stable Diffusion Auto-Encoder | Spencer Szabados </title> <meta name="author" content="Spencer Szabados"> <meta name="description" content="A quick start guild to fine-tuning stable diffusions variational auto-encoder."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?b05f9a0b7405d7c8c89c7465593dea81"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?dadeb9c5d1fd12bc8d37475657446863"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?53a094b51ed1d1e025731eb00d240058" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?4d3046c2f9e13528b0ca4b9c73eb03ec" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8D%81&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://spencerszabados.github.io/projects/2024-05-26-fine-tune-stable-diffusion-vae/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?46af317e693b09921dcb92261d123fbc" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?8b4007b6a6e0a73df09a3389d6f49210"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Spencer</span> Szabados </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Fine-Tune Stable Diffusion Auto-Encoder</h1> <p class="post-meta"> May 26, 2024 </p> <p class="post-tags"> <i class="fa-solid fa-calendar fa-sm"></i> 2024   ·   <i class="fa-solid fa-hashtag fa-sm"></i> graphics   <i class="fa-solid fa-hashtag fa-sm"></i> machine_learning     ·   <i class="fa-solid fa-tag fa-sm"></i> work   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>In a recent project, we (my coauthor and myself) needed to train a denoising diffusion bridge model on 512x512x3 patches from 2048x2048 fundus images take of human eyes. As it is prohibitively expensive, in terms of GPU memory, to train a diffusion model on such high resolutions with memory requirements scaling quadratically with image resolution when using a U-NET backbone, we turned to latent space diffusion models. In particular, we wished to use a fine-tuned version of the auto-encoder from Stable Diffusion. Unfortunately, it was somewhat of a length process finding exactly what training parameters worked well for fine-tuning Stable Diffusions VAE, and a to the point guild. As such, I have composed this short article, which is based on material from <a href="https://wandb.ai/capecape/ddpm_clouds/reports/Using-Stable-Diffusion-VAE-to-encode-satellite-images--VmlldzozNDA2OTgx" rel="external nofollow noopener" target="_blank">capecape</a> and <a href="https://github.com/cccntu/fine-tune-models" rel="external nofollow noopener" target="_blank">cccntu</a>.</p> <hr> <h1 id="overview">Overview</h1> <p>Stable Diffusion (v1-4), as developed by <a href="https://stability.ai/news/stable-diffusion-public-release" rel="external nofollow noopener" target="_blank">stability.ai</a>, is a latent space diffusion model based primarily on the works <a class="citation" href="#Vahdat:2021">(Vahdat et al., 2021; Rombach et al., 2022; Blattmann et al., 2023)</a>, which seek to both improve the efficacy of training high resolution diffusion models as well as overcome the loss in generated image quality from the use of the Variational Autoencoder employed during training.</p> <p>Stable Diffusion is commonly used as a base line model for testing newly developed sampling techniques as (1) its ordinarily capable of generating high quality images on a wide verity of subjects, and (2) its code is open source <a href="https://github.com/CompVis/stable-diffusion" rel="external nofollow noopener" target="_blank">github-CompVis</a>, <a href="https://github.com/Stability-AI/stablediffusion" rel="external nofollow noopener" target="_blank">github-Stability-AI</a> with numerous pre-trained checkpoints trained over huge datasets, which are practically infeasible to replicate at an individual scale, made easily available.</p> <p>However, despite all the data these models have been trained on it is not guaranteed to perform well on any given task; e.g., generating (or just encoding) medical images such as x-rays. To counter act this, researchers (and practitioners) typically fine-tune – running a few additional training steps – the model on some additional examples for the problem being considered. It is important, to ensure consistent results, when fine-tuning a model to select similar training parameters (e.g., the loss used, the step size, etc.) to those used when the model was initially trained; otherwise, training might fail or the performance of the model may degrade when applied outside of this new data (generalization performance decreases).</p> <p>In an effort to save fellow researchers time, I provide a selection of training parameters – which I have found to work well – and a complete training script for fine-tuning Stable Diffusion (v1-4)’s variational auto-encoder.</p> <h1 id="fine-tuning-the-model">Fine-tuning the Model</h1> <p>The complete repository for fine-tuning can be found at <a href="https://github.com/SpencerSzabados/Fine-tune-Stable-Diffusion-VAE" rel="external nofollow noopener" target="_blank">github</a>. Consult the README.md for general usage.</p> <p>Here is an example 512x512x3 image patch from the <a href="https://www.nature.com/articles/s41597-022-01564-3" rel="external nofollow noopener" target="_blank">Fives dataset</a> and corresponding reconstruction after being passed through the VAE.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/image-dither/mike_c4d8color-480.webp 480w,/assets/img/posts/image-dither/mike_c4d8color-800.webp 800w,/assets/img/posts/image-dither/mike_c4d8color-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/posts/image-dither/mike_c4d8color.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" style="margin:auto; display:block; max-width: 400px; " loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>After running 10k fine-tuning steps here is the result.</p> </div> </article> <h2>References</h2> <div class="publications"> <h2 class="bibliography">2023</h2> <ol class="bibliography"><li> <div class="row"> <div class="col-sm-2 abbr"> <abbr class="badge"></abbr> </div> <div id="Blattmann:2023" class="col-sm-8"> <div class="title">Align your Latents: High-Resolution Video Synthesis with Latent Diffusion Models</div> <div class="author"> Andreas Blattmann , Robin Rombach , Huan Ling , and <span class="more-authors" title="click to view 4 more authors" onclick=" var element=$(this); element.attr('title', ''); var more_authors_text=element.text() == '4 more authors' ? 'Tim Dockhorn, Seung Wook Kim, Sanja Fidler, Karsten Kreis' : '4 more authors'; var cursorPosition=0; var textAdder=setInterval(function(){ element.text(more_authors_text.substring(0, cursorPosition + 1)); if (++cursorPosition == more_authors_text.length){ clearInterval(textAdder); } }, '10'); ">4 more authors</span> </div> <div class="periodical"> 2023 </div> <div class="periodical"> </div> <div class="links"> <a href="http://arxiv.org/abs/2304.08818" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">arXiv</a> <a href="https://arxiv.org/abs/2304.08818" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">URL</a> </div> </div> </div> </li></ol> <h2 class="bibliography">2022</h2> <ol class="bibliography"><li> <div class="row"> <div class="col-sm-2 abbr"> <abbr class="badge"></abbr> </div> <div id="Rombach:2022" class="col-sm-8"> <div class="title">High-Resolution Image Synthesis with Latent Diffusion Models</div> <div class="author"> Robin Rombach , Andreas Blattmann , Dominik Lorenz , and <span class="more-authors" title="click to view 2 more authors" onclick=" var element=$(this); element.attr('title', ''); var more_authors_text=element.text() == '2 more authors' ? 'Patrick Esser, Björn Ommer' : '2 more authors'; var cursorPosition=0; var textAdder=setInterval(function(){ element.text(more_authors_text.substring(0, cursorPosition + 1)); if (++cursorPosition == more_authors_text.length){ clearInterval(textAdder); } }, '10'); ">2 more authors</span> </div> <div class="periodical"> <em>In Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition (CVPR)</em> , 2022 </div> <div class="periodical"> </div> <div class="links"> <a href="http://arxiv.org/abs/2112.10752" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">arXiv</a> <a href="https://ommer-lab.com/research/latent-diffusion-models/" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">URL</a> <a href="https://github.com/CompVis/latent-diffusionhttps://arxiv.org/abs/2112.10752" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">Code</a> </div> </div> </div> </li></ol> <h2 class="bibliography">2021</h2> <ol class="bibliography"><li> <div class="row"> <div class="col-sm-2 abbr"> <abbr class="badge"></abbr> </div> <div id="Vahdat:2021" class="col-sm-8"> <div class="title">Score-based Generative Modeling in Latent Space</div> <div class="author"> Arash Vahdat , Karsten Kreis , and Jan Kautz </div> <div class="periodical"> <em>In Advances in Neural Information Processing Systems</em> , 2021 </div> <div class="periodical"> </div> <div class="links"> <a href="http://arxiv.org/abs/2106.05931" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">arXiv</a> <a href="https://openreview.net/forum?id=P9TYG0j-wtG" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">URL</a> <a href="https://openreview.net/pdf?id=P9TYG0j-wtG" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">PDF</a> </div> </div> </div> </li></ol> </div> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/perlin-worms/">Perlin Worms</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/bayer-dithering/">Bayer Dithering</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Spencer Szabados. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: June 02, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?b977fe0c21b2118ed853308b1b923969"></script> <script defer src="/assets/js/bootstrap-toc.min.js?e5d98150f26024952efec2f7f9d30e5c"></script> <script src="/assets/js/no_defer.js?3ff7cc03fd475bd4728929ccd4ecf3f4"></script> <script defer src="/assets/js/common.js?6deead716675b00c409ff8575afa1cdb"></script> <script defer src="/assets/js/copy_code.js?d359581efc54b08366f9ef8219e6e511" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?25eff8ff4144a010e4ad7b31403102cf"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>